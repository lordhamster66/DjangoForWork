{% extends "index.html" %}
{% load tags %}
{% block header-recources %}
    <style>
        .search-container {
            position: absolute;
            width: 196px;
            border: 1px #dddddd solid;
            background-color: white;
        }

        .search-container .search-line {
            text-align: center;
            cursor: pointer;
        }

        .search-container .search-line:hover {
            background-color: #2f72ab;
            color: white;
        }
    </style>
{% endblock %}
{% block right-container-content %}
    <div class="panel panel-primary">
        <div class="panel-heading">
            <h3 class="panel-title" style="height: 30px;line-height: 30px;">
                <span class="pull-left">查看明细</span>
                {#                <button type="button" class="my-dev btn btn-success pull-right">导出EXCEL</button>#}
            </h3>
        </div>
        <div class="panel-body">
            <div class="container-fluid">
                <!-- 工具栏开始 -->
                <div class="row">
                    <span id="alert" style="display: none;"></span>
                    <form class="form-inline pull-right" method="get">
                        {% csrf_token %}
                        <div class="checkbox">
                            {{ check_detail_form.data_type }}
                        </div>
                        <div class="checkbox" style="position: relative;">
                            {{ check_detail_form.qudao_name }}
                            <span style="color: red;">{{ check_detail_form.qudao_name.errors.0 }}</span>
                            <div id="search-cont" class="search-container"></div>
                        </div>
                        <div class="form-group">
                            <label class="sr-only" for="start_time">起始日期</label>
                            {{ check_detail_form.start_time }}
                            <span style="color: red;">{{ check_detail_form.start_time.errors.0 }}</span>
                        </div>
                        <div class="form-group">
                            <label class="sr-only" for="end_time">终止日期</label>
                            {{ check_detail_form.end_time }}
                            <span style="color: red;">{{ check_detail_form.end_time.errors.0 }}</span>
                        </div>
                        <button type="submit" class="btn btn-primary">查询</button>
                    </form>
                </div>
                <!-- 工具栏结束 -->

                <!-- 表格开始 -->
                <div class="row">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                            <tr>
                                {% if query_sets %}
                                    {% check_detail_get_table_head query_sets condition_dict order_by_dict %}
                                {% endif %}
                            </tr>
                            </thead>
                            <tbody>
                            {% for item in query_sets %}
                                <tr>
                                    {% check_detail_get_table_rows request item %}
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- 表格结束 -->
                总计:{{ query_sets.paginator.count }}条
                <!-- 表格脚部开始 -->
                <div class="row">
                    <nav aria-label="Page navigation">
                        <ul class="pagination">
                            {% get_page_ele query_sets condition_dict order_by_dict %}
                        </ul>
                    </nav>
                </div>
                <!-- 表格脚部结束 -->
            </div>
        </div>
    </div>
{% endblock %}
{% block js %}
    <script>
        $(function () {
            //等待用户不输入 1 秒后再去执行 loadData
            var loseInputMillsecs = 1000;
            var clocker = null;

            function loadData() {
                var qudaoName = $("#qudao-name").val();
                if (qudaoName) {
                    $.ajax({
                        url: "/dm/search_channel_name/",
                        type: "POST",
                        data: {"qudaoName": qudaoName},
                        dataType: "JSON",
                        traditional: true,
                        success: function (obj) {
                            if (obj.status) {
                                $("#search-cont").empty();
                                for (var i = 0; i < obj.data.length; i++) {
                                    $("#search-cont").append("<p class='search-line'>" + obj.data[i]["name"] + "</p>")
                                }
                            }
                        }
                    })
                }
                clocker = null;
            }

            // 此函数用来创建计时器，如果用户在规定时间内连续敲击键盘则清空计时器，重新计时
            function innerKeydown() {
                if (null == clocker) {
                    clocker = setTimeout(loadData, loseInputMillsecs);
                }
                else	//连续击键，重新开始计时
                {
                    clearTimeout(clocker);
                    clocker = setTimeout(loadData, loseInputMillsecs);
                }
            }

            // 监测用户键盘输入
            $("#qudao-name").keydown(function () {
                innerKeydown();
            });

            // 用户选取下拉框内容
            $("#search-cont").delegate(".search-line", "click", function () {
                $("#search-cont").empty();
                var qudaoName = $(this).text();
                $("#qudao-name").val(qudaoName);
            });
        })
    </script>
{% endblock %}
